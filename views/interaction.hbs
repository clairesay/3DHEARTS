<body id="interaction" class="common-structure">
    <header>
        <button id="returnToMenu" onclick="exitModule();">
            <img src="images/menu-heart.svg">
        </button>
    </header>
    <section id="navigation-tab">
        <a onclick="jumpSection('{{heartId}}' + '-oe.html', 'Case Examination');">Case Details</a>
        <a onclick="jumpSection('{{heartId}}' + '-interaction.html', 'Interaction');">Exploration</a>
        <a onclick="jumpSection('{{heartId}}' + '-explanation.html', 'Explanation');">Explanation</a>
    </section>

    <section id="modal-blackout" class="no-modal"> </section>
        <section id="modal" class="no-modal">
            <h3 id="on-examination-review">On Examination</h3>
            <h3 id="chest-xr-review">Chest XR</h3>
            <article id="on-examination-review-content">
                <p>
                <ul>
                    {{#each preliminary_information}}
                    {{review this}}
                    {{/each}}
                </ul>

                <h4>Background History</h4>
                <ul>
                    {{#each background_history}}
                    {{review this}}
                    {{/each}}
                </ul>
                <h4>On Examination</h4>
                <ul>
                    {{#each on_examination}}
                    {{review this}}
                    {{/each}}
                </ul>
                </p>
            </article>
            <article id="chest-xr-review-content">
                <img class="chest-xr" src={{xray}}>
            </article>
        </section>
        
    <section id="content-half">
        <div id="module-name">  
            <h1>{{name}}'s Story</h1>
            <h3>Interaction</h3>
            <img class="profile" src="images/photos/{{toLowerCase name}}-recrop.png">
        </div>

        <section class="content module-slide">
            <h1>Interact</h1>
            <p class="case-content">
                For this stage of the module, you will be using a physical model of the paediatric heart case #{{heartId}} and a
                digital interactive model.
            </p>
            <p id="interaction-case-content-button-explanation" class="case-content">
                All the case content you reviewed will be available to you in the case button.
            </p>
            <p class="case-content">
                It will be helpful as you interact with the models as the module progresses.
            </p>
        </section>

        <section class="activity module-slide">
            <article id="toggles">
                <form id="model-toggles">
                    <input type="radio" name="render-type" id="clear" value="clear" checked>
                    <label for="clear" onclick="zoom(-1);">Zoom Out</label>
                    <input type="radio" name="render-type" id="segments" value="segments">
                    <label for="segments" onclick="zoom(1);">Zoom In</label>
                </form>
                <h5>Labels
                    <form id="model-toggles">
                        <input type="radio" name="part-labels" id="on" value="labels-on" checked>
                        <label for="on" onclick="showLabel(1);">On</label>
                        <input type="radio" name="part-labels" id="off" value="labels-off">
                        <label for="off" onclick="showLabel(-1);">Off</label>
                    </form>
                </h5>
            </article>

            <p class="step">Refer to Specimen {{heartId}}
            </p>

            <p class="step"><strong>1. Orient the heart so that you are looking at the posterior aspect.</strong>
                Can you identify the two atrial appendages?
            </p>
            <p class="step"><strong>2. Identify the right atrium and follow it down into its corresponding
                    ventricle</strong>
                Can you identify the features differentiating right from left ventricles?
            </p>
            <p class="step"><strong>3. Identify the right ventricular outflow tract</strong>
            </p>
            <p class="step"><strong>4. Identify the left atrium and follow it down into its corresponding ventricle</strong>
                Does this have the features of a left ventricle?
            </p>
            <p class="step"><strong>5. Identify the left ventricular outflow tract</strong></p>
            <p class="step"><strong>6. Identify any inter-atrial communications.</strong>
                Can you pass a pipe-cleaner through the defect?
            </p>
            <p class="step"><strong>7. Identify any inter-ventricular communications.</strong>
                Can you pass a pipe-cleaner through the defect?
            </p>
            <p class="step"><strong>8. Follow the left ventricular outflow tract into the aortic arch.</strong>
                Can you identify the remnant ligamentum arteriosum or a patent ductus arteriosus?
            </p>
        </section>

        <section class="activity module-slide">
            <h1>How would you summarise the cardiac defects you have identified?</h1>

            <p class="case-content">
                Think carefully about your answer before you proceed to the next page.
            </p>
        </section>

        <section class="activity module-slide">
            <h1>How would you summarise the cardiac defects you have identified?</h1>
            <h3>
                Cardiac Specimen Explanation:
            </h3>
            {{#each cardiac_explanation}}
            {{list this}}
            {{/each}}
            {{!-- <p class="case-content">
                This heart demonstrates atrio-ventricular and ventriculo-arterial concordance. There is a small patent
                foramen ovale (PFO) and a large sub-pulmonary ventricular septal defect. There is right ventricular
                hypertrophy. There is a suggestion of aortic hypoplasia. Note the classic relationship of the great vessels
                â€“ they spiral around each other as they leave the heart, with the aorta located posteriorly.
            </p> --}}
        </section>

        <section class="activity module-slide">
            <p class="case-content">
                Well done on the heart interaction! Proceed to the Explanation Section!
            </p>
        </section>

        <article id="buttons-container">
            <button id="previous" class="nav-button" onclick="nextSlide(-1)">
                    <svg width="33" height="29" viewBox="0 0 33 29" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M29.5305 26.2037L18 14.6731L29.5305 3.14258"/>
                        <path d="M14.5305 26.2037L2.99997 14.6731L14.5305 3.14258"/>
                    </svg>
            </button>
            <button id="next" class="nav-button" onclick="nextSlide(1);">
                    <svg width="63" height="29" viewBox="0 0 63 29" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 26.2037L14.5305 14.6731L3 3.14258"/>
                        <path d="M18 26.2037L29.5305 14.6731L18 3.14258"/>
                        <path d="M33 26.2037L44.5305 14.6731L33 3.14258"/>
                        <path d="M48 26.2037L59.5305 14.6731L48 3.14258"/>
                    </svg>
            </button>
            <button id="next-module" class="text-button" onclick="nextModule()">Explanation</button>
        </article>

        <button id="case-content-button" onclick="showReviewModal();"><img src="images/case-content.svg"></button>
    </section>

    <section id="image-half">
        <div id="heart-model">
            <canvas id="c"></canvas>
            <div id="labels"></div>
        </div>
    </section>
</body>


<script type="module">
    //////////////////////////////////////// COLOUR SWITCH //////////////////////////////////////
    switch ("{{name}}") {
        case "Ben":
            document.documentElement.style.setProperty("--module-colour", "#9B51E0")
            break
        case "Ayanthi":
            document.documentElement.style.setProperty("--module-colour", "#EB5757")
            break
        case "Amin":
            document.documentElement.style.setProperty("--module-colour", "#2F80ED")
            break
        case "Richardson":
            document.documentElement.style.setProperty("--module-colour", "#27AE60")
            break
        default:
            break
    }

    //importing js modules
    import * as THREE from './js/three.module.js';
    import { OBJLoader } from './js/OBJLoader.js';
    import { OrbitControls } from './js/OrbitControls.js';
    import { CSS2DRenderer, CSS2DObject } from './js/CSS2DRenderer.js';
    import TWEEN from 'https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.3.2/Tween.js';

    //Because the module doesn't work otherwise.
    window.camera = camera;

    //Declaring some variables for the labels
    var testLabel, labelRenderer;

    ///////////////////////// SETTING UP THE SCENE /////////////////////////////   

				var scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xc4c4c4 );
				scene.fog = new THREE.Fog( 0xc4c4c4, 10, 50 );

				var hemiLight = new THREE.HemisphereLight( 0xe7e7e7, 0x222222, 0.7 );
				hemiLight.position.set( 0, 20, 0 );

				var dirLight = new THREE.DirectionalLight( 0xe7e7e7, 0.5 );

				dirLight.castShadow = true;
				dirLight.shadow.camera.top = 2;
				dirLight.shadow.camera.bottom = - 2;
				dirLight.shadow.camera.left = - 2;
				dirLight.shadow.camera.right = 2;
				dirLight.shadow.camera.near = 0.1;
				dirLight.shadow.camera.far = 40;

				// ground

				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 100, 100 ), new THREE.MeshPhongMaterial( { color: 0x777777, depthWrite: false } ) );
				mesh.rotation.x = - Math.PI / 2;
                mesh.position.y = -8;
				mesh.receiveShadow = true;
				scene.add( mesh );

    //establishing the scebe abd background color
    //var scene = new THREE.Scene();
    var imageHalf = document.getElementById('image-half')
    //scene.background = new THREE.Color(0x222222);
    var camera = new THREE.PerspectiveCamera(45, imageHalf.clientWidth / imageHalf.clientHeight, 1, 500);
    const canvas = document.querySelector('#c');

    //rendering the window and everything in it
    const renderer = new THREE.WebGLRenderer({canvas});

    //Setting the position of the camera
    camera.position.x = 0;
    camera.position.y = 0;
    camera.position.z = 15;

                camera.add(dirLight);
                camera.add(hemiLight);


    //Lights
    //var light = new THREE.PointLight(0xfefefe, 1.1, 100);
    //light.position.set(camera.position.x, camera.position.y, camera.position.z);
    scene.add(camera);
    //camera.add(light);

    //Adding Orbit Controls
    var controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.minDistance = 10;
    controls.maxDistance = 20;

    //Resizing the renderer as needed
    function resizeRendererToDisplaySize(renderer) {
        const canvas = renderer.domElement;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const needResize = canvas.width !== width || canvas.height !== height;
        if (needResize) {
            renderer.setSize(width, height, false);
        }
        return needResize;
    }

    // Declare variables to manipulate heart object rotation
    var heartObj;
    var xRotation, yRotation, zRotation;

    ///////////////////////// MODEL LOADER /////////////////////////////

    var loader = new OBJLoader()

    loader.load("{{ model }}", function (heart) {
        //material of model
        var material = new THREE.MeshStandardMaterial({
            color: 0xfffee2,
            roughness: 0.75,
            shadowSide: THREE.DoubleSide,
        });

        //centering the model and adding material
        heart.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
                child.geometry.center();
                child.material = material;
            }
        })

        //adding heart to scene
        heart.name = 'heart';
        scene.add(heart);

        //positioning the heart for optimal scale and visibility
        heart.scale.set(0.1, 0.1, 0.1);
        heart.rotation.x = 0;
        heart.rotation.y = 3;
        heart.rotation.z = 0;

        // get heart object to rotate
        heartObj = scene.getObjectByName('heart', true);
    })

    //dots for the label positions
    var dotGeometry = new THREE.Geometry();
    var dotMaterial = new THREE.PointsMaterial( { size: 10, sizeAttenuation: false } );
    var labelDot = new THREE.Points( dotGeometry, dotMaterial );


    //loading the json file with heart labels
    async function loadJSON(url) {
        const req = await fetch(url);
        return req.json();
    }

    //setting heart labels
    let heartLabels;
    async function loadLabelData() {
        heartLabels = await loadJSON('./js/heart-labels.json');  

        //code from three.js fundamentals - plotting labels as though they were on a sphere
        //uses longitude and latitude
        //x
        const latHelper = new THREE.Object3D();

        //y
        const lonHelper = new THREE.Object3D();
        lonHelper.add(latHelper);

        //combining x and y
        const positionHelper = new THREE.Object3D();
        latHelper.add(positionHelper);

        //label parent element
        const labelParentElem = document.querySelector('#labels');
        for (const heartLabel of heartLabels) {
            const {xPosition, yPosition, zPosition, name} = heartLabel;
            // adjust the helpers to point to the latitude and longitude
            latHelper.rotation.x = THREE.MathUtils.degToRad(xPosition);
            lonHelper.rotation.y = THREE.MathUtils.degToRad(yPosition);     
            positionHelper.position.z = zPosition;
            console.log(positionHelper.position.z);

            // get the position of the lat/lon
            positionHelper.updateWorldMatrix(true, false);
            const position = new THREE.Vector3();
            positionHelper.getWorldPosition(position);
            heartLabel.position = position;

            // add label for each object
            const elem = document.createElement('div');
            elem.textContent = name;
            labelParentElem.appendChild(elem);
            heartLabel.elem = elem;
            }
        }
    loadLabelData();

    const tempV = new THREE.Vector3();
    const cameraToPoint = new THREE.Vector3();
    const cameraPosition = new THREE.Vector3();
    const normalMatrix = new THREE.Matrix3();

    function updateLabels() {
        // exit if we have not yet loaded the JSON file
        //all is three.js fundamentals
        if (!heartLabels) {
        return;
        }

        const minVisibleDot = 0.2;
        // get a matrix that represents a relative orientation of the camera
        normalMatrix.getNormalMatrix(camera.matrixWorldInverse);
        // get the camera's position
        camera.getWorldPosition(cameraPosition);

        for (const heartLabel of heartLabels) {
            const {position, elem} = heartLabel;

            //creating a dot on the model for each label
            dotGeometry.vertices.push(position);
            scene.add( labelDot );

            // Orient the position based on the camera's orientation.
            // Since the sphere is at the origin and the sphere is a unit sphere
            // this gives us a camera relative direction vector for the position.
            tempV.copy(position);
            tempV.applyMatrix3(normalMatrix);
        
            // compute the direction to this position from the camera
            cameraToPoint.copy(position);
            cameraToPoint.applyMatrix4(camera.matrixWorldInverse).normalize();
        
            // get the dot product of camera relative direction to this position
            // on the globe with the direction from the camera to that point.
            // 1 = facing directly towards the camera
            // 0 = exactly on tangent of the sphere from the camera
            // < 0 = facing away
            const dot = tempV.dot(cameraToPoint);
 
            // if the orientation is not facing us hide it.
            if (dot > minVisibleDot) {
            elem.style.display = 'none';
            continue;
            }
 
            // restore the element to its default display style
            elem.style.display = '';

            // get the normalized screen coordinate of that position
            // x and y will be in the -1 to +1 range with x = -1 being
            // on the left and y = -1 being on the bottom
            tempV.copy(position);
            tempV.project(camera);
            // convert the normalized position to CSS coordinates
            const x = (tempV.x *  .5 + .5) * canvas.clientWidth;
            const y = (tempV.y * -.5 + .5) * canvas.clientHeight;
            //console.log(x, y);

            // move the elem to that position
            elem.style.transform = `translate(-50%, -50%) translate(${x}px,${y}px)`;

            // set the zIndex for sorting
            elem.style.zIndex = (-tempV.z * .5 + .5) * 100000 | 0;
        }
    }

    //tweening function for smoooth movement
    function tweenView(positionX, positionY, positionZ, rotationX, rotationY, rotationZ) {
        var from = {
            x: camera.position.x,
            y: camera.position.y,
            z: camera.position.z,
            xR: camera.rotation.x,
            yR: camera.rotation.y,
            zR: camera.rotation.z
        };
        var to = {
            x: positionX,
            y: positionY,
            z: positionZ,
            xR: rotationX,
            yR: rotationY,
            zR: rotationZ
        };
        var tween = new TWEEN.Tween(camera.position)
            .to(to, 2000)
            .easing( TWEEN.Easing.Sinusoidal.InOut).start();
    }

    //Animate and Render
    var animate = function () { 
        const canvas = renderer.domElement;
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        if (resizeRendererToDisplaySize(renderer)) {
            const canvas = renderer.domElement;
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
        }
        requestAnimationFrame(animate);
        controls.update();
        TWEEN.update(); 
        updateLabels();
        renderer.render(scene, camera);
    };

    // resize window on event onWindowResize
    window.addEventListener('resize', onWindowResize, false)
    function onWindowResize() {
        camera.aspect = imageHalf.clientWidth / imageHalf.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize((imageHalf.clientWidth), (imageHalf.clientHeight));
    }

    animate();

    //Changing the model views on click with tween.js
    function changeView(step) {
        window.tweenView = tweenView;
        var posX, posY, posZ;
        var rotX, rotY, rotZ;

        switch (step) {
            case 1:
                posX = 7.96
                posY = 5.83
                posZ = 17.4
                rotX = -0.32;
                rotY = 0.41;
                rotZ = 0.13;
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 2:
                posX = 17.26
                posY = 4.45
                posZ = 9.07
                rotX = -0.46
                rotY = 1.04
                rotZ = 0.4
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 3:
                posX = 1.84
                posY = -17.93
                posZ = -8.67
                rotX = 2.02
                rotY = 0.09
                rotZ = -2.95
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 4:
                posX = 0.7
                posY = 5.24
                posZ = 19.29
                rotX = -0.27
                rotY= 0.04
                rotZ = 0.01
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 5:
                posX = -6.19
                posY = -14
                posZ = 12.87
                rotX = 0.83
                rotY = -0.31
                rotZ = 0.32
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 6:
                posX = 17.21
                posY = -10.12
                posZ = 1.24
                rotX = 1.45
                rotY = 1.04
                rotZ = -1.43
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 7:
                posX = 0.37
                posY = -11.82
                posZ = -16.13
                rotX = 2.51
                rotY = 0.02
                rotZ = -3.13
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            case 8:
                posX = -0.4
                posY = -2.64
                posZ = -19.82
                rotX = 3.01
                rotY = -0.02
                rotZ = 3.14
                tweenView(posX, posY, posZ, rotX, rotY, rotZ);
                break;
            default:
                break;
        }
    }

    /////////////////////////////SHOW LABELS///////////////////////////
    window.showLabel = showLabel;
    function showLabel(value) {
        const labelContainer = document.getElementById('labels');
        switch(value) {
            case -1:
            labelDot.visible = false;
            labelContainer.style.display = "none";
                break;
            case 1:
            labelDot.visible = true;
            labelContainer.style.display = "block";
                break;
        }
    }

    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // PREVIOUSLY THIS WAS THE MAIN INTERACTION JS FILE //
    // CONTAINS CLICK THROUGHS RATHER THAN THREE.JS FUNCTIONALITY

    //Because the module doesn't work otherwise.
    window.nextPoint = nextPoint;
    window.nextModule = nextModule;
    window.nextSlide = nextSlide;
    window.nextStep = nextStep;
    window.exitModule = exitModule;
    window.jumpSection = jumpSection;
    window.showReviewModal = showReviewModal;
    window.changeView = changeView;
    ////////////////// TOP LEFT EXIT MODULE ////////////////////
    //Warning to prevent user from accidentally leaving the module
    function exitModule() {
        Swal.fire({
            title: 'Leave Module?',
            text: 'You will be taken back to the Modules Homepage.',
            icon: 'warning',
            showCancelButton: true,
            cancelButtonText: 'Cancel',
            confirmButtonText: 'Leave',
            reverseButtons: true
        }).then((result) => {
            if (result.value) {
                window.location.href = "index.html";
            }
        })
    }



    //////////////////////////////////////// NAVIGATION TAB  //////////////////////////////////////
    //checking for the path name
    var path = window.location.pathname;
    var page = path.split("/").pop();

    //highlighting the text to show the current page displayed
    if (page.includes('oe')) {
        document.querySelectorAll('#navigation-tab a')[0].style.color = "black";
        document.querySelectorAll('#navigation-tab a')[0].style.fontWeight = "700";
        document.querySelectorAll('#navigation-tab a')[0].style.cursor = "default";
    } else if (page.includes('interaction')) {
        document.querySelectorAll('#navigation-tab a')[1].style.color = "black";
        document.querySelectorAll('#navigation-tab a')[1].style.fontWeight = "700";
        document.querySelectorAll('#navigation-tab a')[1].style.cursor = "default";
    } else if (page.includes('explanation')) {
        document.querySelectorAll('#navigation-tab a')[2].style.color = "black";
        document.querySelectorAll('#navigation-tab a')[2].style.fontWeight = "700";
        document.querySelectorAll('#navigation-tab a')[2].style.cursor = "default";
    }
    //If the user clicks on a different section to jump to, warn them before they jump to it
    function jumpSection(destination, sectionName) {
        if (destination == page) {
        } else {
            Swal.fire({
                title: 'Start the ' + sectionName + ' section?',
                text: 'You will leave this module.',
                icon: 'warning',
                showCancelButton: true,
                cancelButtonText: 'Cancel',
                confirmButtonText: 'Start',
                reverseButtons: true
            }).then((result) => {
                if (result.value) {
                    window.location.href = destination;
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                }
            })
        }
    }

    ///////////////////////////////// AT THE END OF A MODULE ///////////////////////////
    //at the end of the module, automatically forward user to the next section
    function nextModule() {
        window.location.href = "" + "{{heartId}}" + "-explanation.html";
    }

    ////////// USING LOCAL STORAGE TO OFFSET IF USER NAVIGATES TO PREVIOUS SLIDE FIXING/////////////
    document.getElementById('previous').addEventListener('click', function pointViewCount() {
        localStorage.setItem('prevCurrentPoint', currentPoint);
    })

    /////////////////////////////////// PROGRESSION THROUGH SLIDES ///////////////////////////////
    let pointIncrement = 0;
    //function to show current slide
    function showSlide(currentSlide) {
        //if the current slide is the first one, hide the previous button and show the next button only
        if (currentSlide == 0) {
            document.getElementById('previous').style.visibility = "hidden"
            document.getElementById('next').style.visibility = "visible"
            //if the current slide is the second last one, show the next-module button, hide the next button and show the previous button
        } else if (currentSlide == (document.querySelectorAll('.module-slide').length - 1)) {
            document.getElementById('previous').style.visibility = "visible"
            document.getElementById('previous').style.display = "flex"
            document.getElementById('next-module').style.visibility = "visible"
            document.getElementById('next-module').style.display = "flex"
            document.getElementById('next').style.visibility = "hidden"
            document.getElementById('next').style.display = "none"
            //show both the previous and next buttons and hide the next-module button at all other times
        } else {
            document.getElementById('previous').style.visibility = "visible"
            document.getElementById('previous').style.display = "flex"
            document.getElementById('next').style.visibility = "visible"
            document.getElementById('next').style.display = "flex"
            document.getElementById('next-module').style.visibility = "hidden"
            document.getElementById('next-module').style.display = "none"
        }

        //show this slide a.k.a current slide
        var thisSlide = document.getElementsByClassName('module-slide')[currentSlide];
        thisSlide.style.display = "flex";
        var caseContent = document.querySelectorAll('.case-content');
        //if this slide contains a class called 'case-content' a.k.a a point in a slide
        for (var i = 0; i < caseContent.length; i++) {
            if ((thisSlide.contains(caseContent[i])) && (true)) {
                //change the next button to show the next point
                document.getElementById('next').setAttribute("onclick", "nextPoint(1);")
            }
        }

        //instead if the current slide has steps i.e. the actual interaction stage
        var stepContent = document.querySelectorAll('.step');
        //check for steps
        for (var i = 0; i < stepContent.length; i++) {
            if ((thisSlide.contains(stepContent[i])) && (true)) {
                //change the next and previous buttons to move through steps
                document.getElementById('next').setAttribute("onclick", "nextStep(1);")
                document.getElementById('previous').setAttribute("onclick", "nextStep(-1);")
                //if the current step is the first step, display it (it doesn't work when this isn't there for some reason)
                if (currentStep == 0) {
                    var firstStep = document.querySelectorAll('.step')[currentStep];
                    firstStep.style.display = "flex"
                }
            }
        }
    }

    //Progression through slides
    var currentSlide = 0;
    function nextSlide(n) {
        //hide the previous slide
        var previousSlide = document.getElementsByClassName('module-slide')[currentSlide];
        previousSlide.style.display = "none";
        //add or minus 1 to current slide, depending on previous or next button click
        currentSlide += n;
        //display the slide
        showSlide(currentSlide);
    }
    showSlide(currentSlide);

    /////////////////////////////////// PROGRESSION THROUGH POINT CONTENT /////////////////////////////

    //This both a progression and display function for showing each point in the module
    var currentPoint = 0;
    function nextPoint(n) {
        //x is the number of elements with the class case-content within the current slide
        var x = document.getElementsByClassName('module-slide')[currentSlide].querySelectorAll('.case-content').length;
        //Add or minus 1 to the current point, depending on previous or next button click
        currentPoint += n;
        pointIncrement++;
        var thisPoint = document.getElementsByClassName('case-content')[currentPoint];

        //if the current point is less than the number existing in this slide
        if (currentPoint < x) {
            //show it
            thisPoint.style.visibility = "visible";
            //if the points on this slide have already been displayed, add on the number to the current point count so that the it skips to the next slide
        } else if (localStorage.hasOwnProperty('prevCurrentPoint') == true) {
            currentPoint == (parseInt(localStorage.getItem('prevCurrentPoint')));
            document.getElementById('next').setAttribute("onclick", "nextSlide(1);");
            document.getElementById('next').click();
            localStorage.clear();
            currentPoint--;
            //if the current point is the maximum number of points in this slide, clear the class name, move on
        } else if (currentPoint == x) {
            for (let i = 0; i < currentPoint; i++) {
                document.getElementsByClassName('module-slide')[currentSlide].querySelectorAll('.case-content')[0].classList = "";
            }
            document.getElementById('next').click();
            document.getElementById('next').setAttribute("onclick", "nextSlide(1);");
            document.getElementById('next').click();
        } else {
            document.getElementById('next').setAttribute("onclick", "nextSlide(1);");
            document.getElementById('next').click();
            currentPoint = 0;
        }
    }

    ////////////////////////////////// PROGRESSION THROUGH STEPS OF INTERACTION /////////////////////////////
    //Progress through the Steps
    var currentStep = 0;
    function nextStep(m) {
        //Increment the steps by either -1 or 1 depending upon previous or next buttons clicked
        currentStep += m;
        //If the current step exists
        if (currentStep > 0) {
            //Hide the previous step
            var previousStep = document.querySelectorAll('.step')[currentStep - 1];
            previousStep.style.display = "none";
        }
        //Show the current step
        showStep();
    }

    //Display the Step
    function showStep() {
        //Number of Steps
        var steps = document.querySelectorAll('.step').length;

        //If the first step hasn't been accessed yet, progress to changing slides
        if (currentStep < 0) {
            document.getElementById('next').setAttribute("onclick", "nextSlide(1);");
            document.getElementById('previous').setAttribute("onclick", "nextSlide(-1);");
            document.getElementById('previous').click();
            currentStep = 0;

            //If the current step is less than the number of steps that exist but greater than 0
        } else if ((currentStep < steps) && (currentStep >= 0)) {
            var thisStep = document.querySelectorAll('.step')[currentStep];
            for (let l = 0; l < steps; l++) {
                //And if step[l] doesn't equal to the current step that is being displayed
                if (l != currentStep) {
                    document.querySelectorAll('.step')[l].style.display = "none";
                }
            }
            //show this step
            thisStep.style.display = "flex";
            // Switch View in Three
            changeView(currentStep)

            //If the current step has reached the number of existing steps, progress to changing slides
        } else if (currentStep == (steps)) {
            document.getElementById('next').setAttribute("onclick", "nextSlide(1);");
            document.getElementById('previous').setAttribute("onclick", "nextSlide(-1);");
            document.getElementById('next').click();
        }
    }

    /////////////////////////////////////// MODAL REVIEW INFORMATION /////////////////////////////////////////////

    //Toggling display of review information in modal
    function showReviewModal() {
        //Modal Background
        var modalBlackout = document.getElementById('modal-blackout');
        modalBlackout.classList.toggle('show-modal');
        //Actual Modal
        var modal = document.getElementById('modal');
        modal.classList.toggle('show-modal');
    }

    //Selecting onexamination and chest xr review titles and content
    var OEReviewHeading = document.getElementById('on-examination-review');
    var chestXRReviewHeading = document.getElementById('chest-xr-review');
    var OEReviewContent = document.getElementById('on-examination-review-content');
    var chestXRReviewContent = document.getElementById('chest-xr-review-content');

    //On Examination
    //Check if OE heading is clicked to show OE review content
    OEReviewHeading.addEventListener('click', function showOEReview() {
        chestXRReviewHeading.style.backgroundColor = "var(--default-module-colour)";
        OEReviewHeading.style.backgroundColor = "white";
                OEReviewHeading.style.color = "var(--default-module-colour)";
        chestXRReviewHeading.style.color = "white";
        OEReviewContent.style.display = "flex";
        chestXRReviewContent.style.display = "none";
    })

    //Chest XR
    //Check if Chest XR heading is clicked to show Chest XR review content
    chestXRReviewHeading.addEventListener('click', function showChestXRReview() {
                OEReviewHeading.style.backgroundColor = "var(--default-module-colour)";
        chestXRReviewHeading.style.backgroundColor = "white";
        chestXRReviewHeading.style.color = "var(--default-module-colour)";
        OEReviewHeading.style.color = "white";

        OEReviewContent.style.display = "none";
        chestXRReviewContent.style.display = "flex";
    })

//if click on model-label

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			if ( /(iPad|iPhone|iPod)/g.test( navigator.userAgent ) ) {

				viewer.style.width = getComputedStyle( viewer ).width;
				viewer.style.height = getComputedStyle( viewer ).height;
				viewer.setAttribute( 'scrolling', 'no' );

			}
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>